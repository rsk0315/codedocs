% ダブリング

ある処理を何度も行った際の結果を求めるためのフレームワーク．

モノイド $(T, \oplus)$ があり，処理 $f: T\ni x\mapsto x'\in T$ が与えられているとする．
処理回数 $m$ と対象 $i$ に対して，$f^m(x)$ を $\log_2 m+O(1)$ time で求める．

また，処理 $f$ に伴ってコストが発生するとき，$f^m(x)$ に伴うコストも求められる．
コストの型を $U$ としたとき，次のような条件を仮定する．
- $f(x)$ で生じるコストの値は $x$ によって定まり，$g(x)$ とおく．
- $f(f(x))$ で生じるコストは，$g(x) \circ g(f(x))$ である．
- $(U, \circ)$ はモノイドを成す．

## 方法

$f^p$ と $f^q$ が得られていれば，$f^{p+q}$ が計算できることに注意する．
任意の正整数 $m$ は，2 べきの整数の和で表せることから，$f^{2^k}$ が求められればうれしい．

$m$ が与えられたとき，どのような $f^{2^k}$ を選べばよいかは，二進表記を考えながらビット演算で求められる．

---

まず，各 $x$ に対して $f(x)$ を求める．必要に応じて $g(x)$ も求めておく．

$f^{2^k}$ が求まっていれば，これに $f^{2^k}(x)$ を渡すことで $f^{2^{k+1}}$ を求められる．
$$ f^{2^k}(f^{2^k}(x)) = f^{2^{k+1}}(x). $$
$g^{2^{k+1}}$ についても同様にできる．

これを繰り返し，所望の $m$ に対して $2^k \ge m$ となる $k$ 以下の各 $k'$ について $f^{2^{k'}}$ を求めると十分．

$f^{2^0}$ についてはクエリで必要になるものを求め，それ以降は到達可能なもののみ求めればよい．
$|T|$ が十分小さければ，すべて求めてしまっても問題ない．

## 繰り返し二乗法

モノイド $(T, \oplus)$ の元 $x$ と非負整数 $m$ について，$x^m =\\,\underset{m\text{ times}}{\underbrace{x\oplus x\oplus\dots\oplus x}}$ を求める．

- $y \gets e_{\oplus}$
- while $m > 1$
  - if $m$ is odd
    - $y \gets y \oplus x$
  - $x \gets x \oplus x$
  - $m \gets (m \gg 1)$
- return $y$

正方行列の累乗に用いられることが多い．